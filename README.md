
# Анализ динамики котировок Сургутнефтегаза

Данные, на основе которых выполнен проект, получены с помощью парсинга сайта MOEX, где выбрана страница "итоги торгов". Полученный парсинг покрывает котировки акций Сургутнефтегаза, Сбербанка, а также цены фьючерсов на нефть марки Brent и на доллар Si в период с 2015 по 2023 год.

Идеи и цели нашего проекта:
1) Собрать данные, проверить, насколько признаки (нефть, валюта, Сбер, Сургутнефтегаз) зависимы друг от друга. 
2) Проверить связь налогового периода и курса доллара, чтобы понять, насколько день месяца имеет влияние на признак, имеющий сильную положительную корреляцию с таргетом - ценой Сургутнефтегаза.
3) Создать прогноз цены Сургутнефтегаза на основе таких признаков, как Br, Si, Sber с помощью машинного обучения.
4) Проанализировать адекватность прогнозной цены.
5) Исследовать аномальные значения в котировках Сургутнефтегаза с помощью машинного обучения.
6) Проверить гипотезы, которые дают большее понимание о том, насколько интересно инвестировать в Сургутнефтегаз.


## Файлы в репозитории

 - [Парсинг данных с сайта Московской Биржи](https://github.com/sungfala/Project_Python/blob/main/Шаг%201.%20Парсинг.ipynb)
 - [Анализ полученных данных](https://github.com/sungfala/Project_Python/blob/main/Шаг%202.%20Анализ%20полученных%20данных.ipynb)
 - [Проверка гипотезы о налоговом периоде](https://github.com/sungfala/Project_Python/blob/main/Шаг%203.%20Гипотеза%20о%20налоговом%20периоде.ipynb)
 - [Линейная регрессия](https://github.com/sungfala/Project_Python/blob/main/Шаг%204.%20Линейная%20регрессия.ipynb)
 - [Поиск аномалий](https://github.com/sungfala/Project_Python/blob/main/Шаг%205.%20Поиск%20аномалий.ipynb)
 - [Гипотезы о матожидании и доходных днях](https://github.com/sungfala/Project_Python/blob/main/Шаг%206.%20Гипотезы%20о%20матожидании%20и%20доходных%20днях.ipynb)


## Шаг 1. Парсинг

На данном этапе мы с помощью Силениума спарсили 4 признака: фьючерс на нефть Брент, фьючерс на доллар, Сбер и Сургутнефтегаз. Всего в цикле получилось 102 странице данных, которые нужно вставить в конечную таблицу из 2021 строки по каждому признаку.

Ссылки на источники данных:
1) SNGS: https://www.moex.com/ru/marketdata/#/mode=instrument&secid=SNGS&boardgroupid=57&mode_type=history&date_from=2022-10-01&date_till=2023-05-01
2) SBER: https://www.moex.com/ru/marketdata/#/mode=instrument&secid=SBER&boardgroupid=57&mode_type=history&date_from=2022-10-01&date_till=2023-05-01
3) Si: https://www.moex.com/ru/forts/contractbaseresults.aspx?base=Si
4) Br: https://www.moex.com/ru/forts/contractbaseresults.aspx?base=OG

Далее в файле парсинга исправлялись ошибки, связанные с непрочтением запятых, а также данные приводились к виду, из которого уже можно строить анализ.
 
 
 ## Шаг 2. Анализ полученных данных
 
Из 1 шага получены таблицы: 

__df_main__ (результат объединения данных, полученных путём парсинга с сайта Московской биржи - цены, дата торгов по каждому из тикеров);

__df_info__ (аггрегированная по дате и коду инструмента df_main);

__df_scaled__ (отскалированная с помощью MinMaxScaler таблица df_info);

__df_r__ (таблица доходностей). 

В ходе анализа были найдены значения и визуализации корреляции таргетированного показателя с остальными инструментами. Мы получили вывод о том, что Сбербанк и Сургутнефтегаз имеют высокую положительную связь по графикам, но связь между ценой на доллар и ценой на акции сомнительна, хотя есть теоретические предпосылки для их зависимости. Подобный анализ мы провели и с доходностями.

Также мы построили графики динамики цен и гистограммы распределения доходностей для каждого из инструментов, для того чтобы лучше понимать глобальные тренды и отклонения в сравнении друг с другом.

Далее мы нашли средние значения доходностей по показателям, стандартные отклонения, VAR и ES, построили график зависимости последних (с данным графиком можно ознакомиться в html версии). 

В конце были построены графики динамики цены Сургута и скользящей средней при различных window size. Спойлер: динамика котировок Сургута в целом разочаровывающая, с плоской тенденцией и сезонными колебаниями из-за выплаты дивидендов летом. После краха акции медленно растут, но не приводят к общей положительной тенденции. 

По найденным связям и теоретическим предпосылкам мы определили, на какие признаки будем ориентироваться в предсказании цены Сургутнефтегаза в 2024 году.

 
 ## Шаг 3. Гипотеза о налоговом периоде
 
На этом шаге мы создали несколько категориальных признаков: налоговый период, динамика роста. Налоговый период принимался за 1, если число, в которое шли торги, входило в промежуток с 22 по 28. 

Н0: курс рубля и налоговый период не связаны

Н1: если начинается налоговый период, рубль укрепляется

Далее посмотрели, имеет ли влияние налоговый период на котировки доллара, который уже непосредственно напрямую коррелирует с котировками Сургутнефтегаза. Корреляция есть, потому что это компания-экспортер и компания-держатель огромной валютной кубышки. Спойлер: то, что влияния нет, мы доказали с помощью хи-квадрат критерия, доли правильных ответов и фундаментального анализа. Пришли к выводу, что в дальнейшем исследовании таргет цены Сургута критерий "налоговый период" не поможет.
 

## Шаг 4. Линейная регрессия

Изначально наша идея заключалась в том, чтобы собрать консенсус-прогнозные значения признаков, которые дают ведущие инвест-дома и банки, и вставить их в модель, которая по ним предскажет таргет цену Сургутнефтегаза на 2024 год. Этой стратегии мы и придерживались.

Средневзвешенные прогнозные цены на 2024 год:

1) Нефть Brent - 87
2) Фьючерс на доллар Si - 60 000
3) SBER - 210

С помощью данной стратегии мы получили прогнозную цену, а потом оптимизировали модель линейной регрессии (подбирая параметры), чтобы улучшать метрики, по которым модель оценивается.

Test MAPE = 0.0954;
Train MAPE = 0.0883;
Test RMSE = 5.2514;
Train RMSE = 4.7846.

Спойлер: средняя прогнозная цена Сургутнефтегаза на 2024 год составит 27 рублей с копейками ;)


## Шаг 5. Поиск аномалий

Эта часть общей работы основана на статье "ANOMALY DETECTION IN UNIVARIATE TIME-SERIES: A SURVEY ON THE STATE-OF-THE-ART" (https://arxiv.org/pdf/2004.00433.pdf).

An anomaly is an observation or a sequence of observations which deviates remarkably from the general distribution of data. Поиском таких наблюдений мы дальше и будем заниматься, рассматривая датасет дневной доходности SNGS с 2015 года.

Anomaly detection является полезным в различных случаях. Например, нахождение аномалий в нашем случае может быть полезно для риск-менеджмента: будут анализироваться причины найденных аномалий, которые будут учитываться при выставлении риск-параметров. Помимо этого, регуляторы могут считать аномалии симптоном манипуляций рынком.

Будем использовать метод Local Outlier Factor (LOF) для поиска аномалий. По просту говоря, LOF - это kNN на максималках (учитывает дополнительно плотность объектов, рассчитывая "под капотом" помимо обычного расстояния другие метрики). Более подробное описание метода можно найти в статье.

Для нашей работы поиск аномалий может служить дополнительным критерием, согласно которому мы делаем вывод: инвестировать или нет, рискованно или нет.

<img width="947" alt="Снимок экрана 2023-06-14 в 21 00 48" src="https://github.com/sungfala/Project_Python/assets/133535097/2d0be7db-0671-418f-91d6-6dc9752e3085">

Спойлер: картинка с аномалиями выглядит так, и, если опустить сравнительный анализ по рынку РФ и подобным компаниям, выглядит достаточно волатильно и рискованно.


## Шаг 6. Гипотезы о матожидании и доле доходных дней

H0: матожидание цены Сургутнефтегаза за последний год равняется цене после дивидендного гэпа в 2022 году.

H1: матожидание цены Сургутнефтегаза за последний год не равняется цене после дивидендного гэпа в 2022 году.

Если мы рассчитаем, что МО цены на протяжении года остается равным цене после дивгэпа, то в качестве инвестиции СНГС - плохая акция (если это не дивстратегия). В таком случае, мы можем предсказать, что после выплаты дивидендов в этом году гэп откроется и, фактически, еще год будет с МО в виде цены после отсечки.

Проверка данной гипотезы проведена также по 2019 году, чтобы снизить риск искаженности данных на определенном таймфрейме.

Н0: px = py, где px - доля дней, когда доходность Сургута > 0, py - доля дней, когда доходность Сбера > 0

H1: px != py

Если доля дней одинакова, то нам при прочих равных одинаково выгодно вложиться в прокси российского рынка - в Сбер, и в Сургут, поэтому Сургут является хорошей инвест идеей. Конечно, также имеет значение показатель бета - он определит, насколько колебания цены акции (пусть и в том же направлении), больше или меньше, чем всего рынка. Но если исходить просто из дней доходности, принимая как факт (например, уже посчитано на некоторых инвест сайтах) бету меньше 1 (колебания меньше рынка), есть смысл судить по доходным дням.

Исходя из проведенного анализа финансового рынка, мы можем сказать, что Сургутнефтегаз - определенно не инвестиционно-спекулятивная стратегия. И это подтверждают гипотезы: ___годовой рост съедается выплачиваемыми дивидендами, и реальный рост цены акции склонен появляться лишь в моменты, когда на рынке царит эйфория___. При этом даже не во все дни эйфории котировки показывают плюс: гипотеза о равенстве долей доходных дней для Сургута и Сбера оказалась отвергнута.

Если говорить о том, склонны ли мы советовать данную стратегию, прогноз по МО говорит, что в этом есть смысл. В какой-то степени акция может стать защитной гаванью, если будут выплачиваться дивиденды, потому что матожидание за год не меньше чем цена после дивгэпа, а другие акции уходят в глубокий убыток. К тому же, если доля доходных дней близка к половине, общий вью по акции не негативный.

## Вывод

Благодаря разностороннему анализу, мы сделали наш собственный прогноз по динамике котировок Сургутнефтегаза. Наш совет - держать. Акция волатильна, что подтверждает машинное обучение с поиском аномалий, однако на горизонте года от нее можно ожидать прибыли и закрытия дивгэпа - дивидендная стратегия имеет место быть.

Также мы установили некоторую связь со Сбером, нефтью и долларом, поэтому при принятии решения в любой момент времени можно возвращаться к этим признакам и смотреть, какую они показывают динамику.

### Authors

- Головинская Анастасия (tg: @stasygol)
- Киосе Анна (tg: @akiose)
- Охотин Даниил (tg: @danokil)

